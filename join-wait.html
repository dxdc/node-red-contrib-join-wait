<script type="text/x-red" data-template-name="join-wait">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-paths"><i class="fa code-fork"></i> Paths</label>
        <input type="text" id="node-input-paths" placeholder='["path_1", "path_2"]'>
    </div>
    <div class="form-row">
        <label for="node-input-pathTopic"><i class="fa fa-bookmark-o"></i> Paths topic</label>
        <input type="text" id="node-input-pathTopic" placeholder='paths'>
        <input type="hidden" id="node-input-pathTopicType">
    </div>
    <div class="form-row">
        <label for="node-input-correlationTopic"><i class="fa fa-bookmark-o"></i> Correlation topic</label>
        <input type="text" id="node-input-correlationTopic" placeholder='_msgid'>
        <input type="hidden" id="node-input-correlationTopicType">
    </div>
    <div class="form-row">
        <label for="node-input-timeout"><i class="fa fa-clock-o"></i> Timeout (ms)</label>
        <input type="text" id="node-input-timeout" placeholder="Timeout">
    </div>
    <div class="form-row">
        <label for="node-input-exactOrder"><i class="fa fa-sort"></i> Sequence order</label>
        <select id="node-input-exactOrder" style="width:100%; margin-right:5px;">
            <option value="false">Any order</option>
            <option value="true">Exact order</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-firstMsg"><i class="fa fa-comments-o"></i> Base message</label>
        <select id="node-input-firstMsg" style="width:100%; margin-right:5px;">
            <option value="true">First received</option>
            <option value="false">Last received</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-mapPayload"><i class="fa fa-arrow-right"></i> Merged data</label>
        <select id="node-input-mapPayload" style="width:100%; margin-right:5px;">
            <option value="false">Original Paths topic</option>
            <option value="true">Overwrite Paths topic with msg.payload</option>
        </select>
    </div>
    <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('join-wait', {
        category: 'function',
        color: '#8baac7',
        defaults: {
            name: {
                value: ''
            },
            paths: {
                value: '["path_1", "path_2"]',
                validate: function(v) {
                    if (v === '') {
                        return true;
                    }
                    try {
                        const json = JSON.parse(v);
                        return Array.isArray(json) && json.length > 0;
                    } catch (err) {
                        return false;
                    }
                }
            },
            pathTopic: {
                value: 'paths'
            },
            pathTopicType: {
                value: 'msg'
            },
            correlationTopic: {
                value: '_msgid'
            },
            correlationTopicType: {
                value: 'msg'
            },
            timeout: {
                value: 15000,
                required: true,
                validate: function(v) {
                    return (Number(v) || 0) > 0;
                }
            },
            exactOrder: {
                value: 'false',
                required: true
            },
            firstMsg: {
                value: 'true',
                required: true
            },
            mapPayload: {
                value: 'false',
                required: true
            }
        },
        inputs: 1,
        outputs: 2,
        outputLabels: ['success', 'expired'],
        icon: 'node-red-contrib-join-wait.png',
        label: function() {
            return this.name || 'join-wait';
        },
        labelStyle: function() {
            return (this.name) ? 'node_label_italic' : '';
        },
        oneditprepare: function() {
            var node = this;
            var previousValueType = {
                value: 'prev',
                label: this._('join-wait.previous'),
                hasValue: false
            };
            $('#node-input-correlationTopic').typedInput({
                default: this.correlationTopicType || 'msg',
                typeField: $('#node-input-correlationTopicType'),
                types: ['msg', 'flow', 'global', 'jsonata']
            });
            $('#node-input-pathTopic').typedInput({
                default: this.pathTopicType || 'msg',
                typeField: $('#node-input-pathTopicType'),
                types: ['msg']
            });
        }
    });
</script>

<script type="text/x-red" data-help-name="join-wait">
    <p>This node waits for messages from all items in the <code>Paths</code> array, which must be received inside of a designated time window.</p>
    <p>If all of the messages are received in that interval, a merged output is sent to the <code>success</code> output. Otherwise, any expired messages are sent to the <code>timeout</code> output. Either output can be optionally connected for further processing.</p>
    <p>In the event of multiple/duplicate messages, the time window is adjusted as needed to continue evaluation on subsequent messages.</p>

    <h3>Details</h3>
    <p>Each item in the <code>Paths</code> array corresponds with an input path to wait for. E.g., <code>["path_1", "path_2", "other_path"]</code>. This can also be configured at runtime by passing an array using <code>msg.pathsToWait</code>.</p>  
    <p><code>Paths topic</code> is a <code>msg</code> variable used to check each flow to see if all of the elements in <code>Paths</code> are matched. This can be <code>msg.topic</code>, <code>msg.paths</code>, etc. If this is not specified, <code>msg.paths</code> will be assumed.</p>
    <p>Note that <code>Paths topic</code> can be set in one of two ways:</p>
    <p>1. As a string, set to the path to check, e.g., <code>msg.paths = "path_1";</code></p>
    <p>2. As an object, set to any value (e.g., <code>msg.paths["path_1"] = {"example": "data"};</code> or <code>msg.paths["path_1"] = 42;</code>).</p>
    <p>If an object is used, multiple paths can be specified. This can be useful if one flow needs to trigger multiple paths.</p>
    <p><code>Correlation topic</code> can be set, if desired, to a variable to ensure that only related messages are grouped. E.g., <code>msg._msgid</code> can be used to ensure that only messages from a *single* split flow are grouped together. If left blank, all messages will be assumed to be related.</p>
    <p><code>Timeout</code> in milliseconds is required to designate the time window to receive all of the messages from <code>Paths</code>.</p>
    <p><code>Sequence order</code> defines the criteria to evaluate the received messages. If multiple messages arrive, e.g., <code>["path_1", "path_2", "path_2", "path_1", "path_2", "path_2" "path_3"]</code>, the *exact* match is only triggered for this sequence: <code>["path_1", "path_2", "path_2" "path_3"]</code>.</p>
    <p><code>Base message</code> defines which message object should be returned as the base message. Either the first message in a sequence or the last.</p>
    <p><code>Merged data</code> defines how the data from <code>msg.paths</code> (or, another designed <code>Paths topic</code>) will be returned. Either, it can be merged in its original form, or, it can be overwritten with each respective <code>msg.payload</code>. This merged data is then appended to the <code>Base message</code>.</p>

    <h3>Caveats</h3>
    <p>Only the data from a single <code>Paths</code> item is returned. E.g., if two <code>path_2</code> messages arrive, only the data from the final one will be returned.</p>
    <p>If <code>msg.pathsToWait</code> is used instead of setting <code>Paths</code>, note that each successive <code>msg.pathsToWait</code> will overwrite the previously stored global value. Due to the nature of the timeout, these <code>Paths</code> need to be able to be evaluated even after a message has arrived. Using a runtime <code>msg.pathsToWait</code> along with different <code>Correlation topics</code> may cause unexpected behavior.</p>
    <p>The <code>timeout</code> should be padded with a small amount of overhead (i.e., ~5 ms or so) for the time it takes to evaluate all of the messages and conditions. This may become critical under very short timeouts.</p>    
</script>
